

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  
    <meta name="description" content="">
  
  <meta name="author" content="十六夜紫菀 / IzayoiAster">
  <meta name="keywords" content="">
  
  <title>Shiro学习笔记 - 紫菀的小窝</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Aster's nest</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Shiro学习笔记">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-11-16 08:36" pubdate>
        2021年11月16日 早上
      </time>
    </span>
  
</div>

<div class="mt-1">
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Shiro学习笔记</h1>
            
            <div class="markdown-body">
              <h2 id="权限的管理"><a href="#权限的管理" class="headerlink" title="权限的管理"></a>权限的管理</h2><h3 id="什么是权限管理"><a href="#什么是权限管理" class="headerlink" title="什么是权限管理"></a>什么是权限管理</h3><p>基本上涉及到用户参与的系统都要进行权限管理，权限管理属于系统安全的范畴，权限管理实现<code>对用户访问系统的控制</code>，按照安全规则或者<a target="_blank" rel="noopener" href="http://baike.baidu.com/view/160028.htm">安全策略</a>控制用户可以访问而且只能访问自己被授权的资源。</p>
<p>权限管理包括用户<code>身份认证</code>和<code>授权</code>两部分，简称<code>认证授权</code>。对于需要访问控制的资源用户首先经过身份认证，认证通过后用户具有该资源的访问权限方可访问。</p>
<h3 id="什么是身份认证-amp-授权"><a href="#什么是身份认证-amp-授权" class="headerlink" title="什么是身份认证&amp;授权"></a>什么是身份认证&amp;授权</h3><p><code>身份认证</code>，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。对于采用<a target="_blank" rel="noopener" href="http://baike.baidu.com/view/5628.htm">指纹</a>等系统，则出示指纹；对于硬件Key等刷卡系统，则需要刷卡。</p>
<p><code>授权，即访问控制</code>，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的</p>
<hr>
<h2 id="什么是Shiro"><a href="#什么是Shiro" class="headerlink" title="什么是Shiro"></a>什么是Shiro</h2><blockquote>
<p><strong>Apache Shiro™</strong> is a powerful and easy-to-use Java security framework that performs authentication, authorization, cryptography, and session management. With Shiro’s easy-to-understand API, you can quickly and easily secure any application – from the smallest mobile applications to the largest web and enterprise applications.  </p>
<p>Shiro 是一个功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理。使用Shiro易于理解的API，您可以快速轻松地保护任何应用程序—从最小的移动应用程序到最大的web和企业应用程序。</p>
</blockquote>
<p><code>Shiro是apache旗下一个开源框架，它将软件系统的安全认证相关的功能抽取出来，实现用户身份认证，权限授权、加密、会话管理等功能，组成了一个通用的安全认证框架。</code></p>
<hr>
<h2 id="Shiro的核心架构"><a href="#Shiro的核心架构" class="headerlink" title="Shiro的核心架构"></a>Shiro的核心架构</h2><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.mn3n4x0jysg.webp" srcset="/img/loading.gif" alt="image"></p>
<h3 id="Subject"><a href="#Subject" class="headerlink" title="Subject"></a>Subject</h3><p><code>Subject即主体</code>，外部应用与subject进行交互，subject记录了当前操作用户，将用户的概念理解为当前操作的主体，可能是一个通过浏览器请求的用户，也可能是一个运行的程序。    Subject在shiro中是一个接口，接口中定义了很多认证授相关的方法，外部程序通过subject进行认证授，而subject是通过SecurityManager安全管理器进行认证授权</p>
<h3 id="SecurityManager"><a href="#SecurityManager" class="headerlink" title="SecurityManager"></a>SecurityManager</h3><p><code>SecurityManager即安全管理器</code>，对全部的subject进行安全管理，它是shiro的核心，负责对所有的subject进行安全管理。通过SecurityManager可以完成subject的认证、授权等，实质上SecurityManager是通过Authenticator进行认证，通过Authorizer进行授权，通过SessionManager进行会话管理等。</p>
<p><code>SecurityManager是一个接口，继承了Authenticator, Authorizer, SessionManager这三个接口。</code></p>
<h3 id="Authenticator"><a href="#Authenticator" class="headerlink" title="Authenticator"></a>Authenticator</h3><p><code>Authenticator即认证器</code>，对用户身份进行认证，Authenticator是一个接口，shiro提供ModularRealmAuthenticator实现类，通过ModularRealmAuthenticator基本上可以满足大多数需求，也可以自定义认证器。</p>
<h3 id="Authorizer"><a href="#Authorizer" class="headerlink" title="Authorizer"></a>Authorizer</h3><p><code>Authorizer即授权器</code>，用户通过认证器认证通过，在访问功能时需要通过授权器判断用户是否有此功能的操作权限。</p>
<h3 id="Realm"><a href="#Realm" class="headerlink" title="Realm"></a>Realm</h3><p><code>Realm即领域</code>，相当于datasource数据源，securityManager进行安全认证需要通过Realm获取用户权限数据，比如：如果用户身份数据在数据库那么realm就需要从数据库获取用户身份信息。</p>
<ul>
<li>注意：不要把realm理解成只是从数据源取数据，在realm中还有认证授权校验的相关的代码。</li>
</ul>
<h3 id="SessionManager"><a href="#SessionManager" class="headerlink" title="SessionManager"></a>SessionManager</h3><p><code>sessionManager即会话管理</code>，shiro框架定义了一套会话管理，它不依赖web容器的session，所以shiro可以使用在非web应用上，也可以将分布式应用的会话集中在一点管理，此特性可使它实现单点登录。</p>
<h3 id="SessionDAO"><a href="#SessionDAO" class="headerlink" title="SessionDAO"></a>SessionDAO</h3><p><code>SessionDAO即会话dao</code>，是对session会话操作的一套接口，比如要将session存储到数据库，可以通过jdbc将会话存储到数据库。</p>
<h3 id="CacheManager"><a href="#CacheManager" class="headerlink" title="CacheManager"></a>CacheManager</h3><p><code>CacheManager即缓存管理</code>，将用户权限数据存储在缓存，这样可以提高性能。</p>
<h3 id="Cryptography"><a href="#Cryptography" class="headerlink" title="Cryptography"></a>Cryptography</h3><p><code>Cryptography即密码管理</code>，shiro提供了一套加密/解密的组件，方便开发。比如提供常用的散列、加/解密等功能。</p>
<hr>
<h2 id="Shiro中的认证"><a href="#Shiro中的认证" class="headerlink" title="Shiro中的认证"></a>Shiro中的认证</h2><h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>身份认证，就是判断一个用户是否为合法用户的处理过程。最常用的简单身份认证方式是系统通过核对用户输入的用户名和口令，看其是否与系统中存储的该用户的用户名和口令一致，来判断用户身份是否正确。</p>
<h3 id="Shiro中认证的关键对象"><a href="#Shiro中认证的关键对象" class="headerlink" title="Shiro中认证的关键对象"></a>Shiro中认证的关键对象</h3><ul>
<li><strong>Subject：主体</strong></li>
</ul>
<p>访问系统的用户，主体可以是用户、程序等，进行认证的都称为主体； </p>
<ul>
<li><strong>Principal：身份信息</strong></li>
</ul>
<p>是主体（subject）进行身份认证的标识，标识必须具有<code>唯一性</code>，如用户名、手机号、邮箱地址等，一个主体可以有多个身份，但是必须有一个主身份（Primary Principal）。</p>
<ul>
<li><strong>credential：凭证信息</strong></li>
</ul>
<p>是只有主体自己知道的安全信息，如密码、证书等。</p>
<h3 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h3><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.y8sa00upugw.webp" srcset="/img/loading.gif" alt="image"></p>
<h3 id="认证的开发"><a href="#认证的开发" class="headerlink" title="认证的开发"></a>认证的开发</h3><h4 id="创建项目并引入依赖"><a href="#创建项目并引入依赖" class="headerlink" title="创建项目并引入依赖"></a>创建项目并引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.shiro/shiro-core --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="引入shiro配置文件shiro-ini并加入如下配置"><a href="#引入shiro配置文件shiro-ini并加入如下配置" class="headerlink" title="引入shiro配置文件shiro.ini并加入如下配置"></a>引入shiro配置文件shiro.ini并加入如下配置</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[users]</span><br><span class="hljs-attr">aster</span>=<span class="hljs-number">123</span><br><span class="hljs-attr">lotus</span>=<span class="hljs-number">456</span><br></code></pre></td></tr></table></figure>

<h4 id="开发认证代码"><a href="#开发认证代码" class="headerlink" title="开发认证代码"></a>开发认证代码</h4><blockquote>
<p>Ctrl + H查看SecManager类的结构图</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuthenticator</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 创建安全管理器对象</span><br>        DefaultSecurityManager securityManager = <span class="hljs-keyword">new</span> DefaultSecurityManager();<br><br>        <span class="hljs-comment">// 给安全管理器设置Realm</span><br>        securityManager.setRealm(<span class="hljs-keyword">new</span> IniRealm(<span class="hljs-string">&quot;classpath:shiro.ini&quot;</span>));<br><br>        <span class="hljs-comment">// 给全局安全工具类设置安全管理器</span><br>        SecurityUtils.setSecurityManager(securityManager);<br><br>        <span class="hljs-comment">// 关键对象 Subject 主体</span><br>        Subject subject = SecurityUtils.getSubject();<br><br>        <span class="hljs-comment">// 创建令牌</span><br>        UsernamePasswordToken token = <span class="hljs-keyword">new</span> UsernamePasswordToken(<span class="hljs-string">&quot;asteir&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);<br><br>        <span class="hljs-comment">// 用户认证</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            subject.login(token);<br>            System.out.println(<span class="hljs-string">&quot;认证状态：&quot;</span> + subject.isAuthenticated()); <span class="hljs-comment">// 认证状态：true</span><br>        &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：用户名不存在&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException e) &#123; <span class="hljs-comment">// 无效凭证</span><br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：密码错误&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><p>DisabledAccountException（帐号被禁用）</p>
</li>
<li><p>LockedAccountException（帐号被锁定）</p>
</li>
<li><p>ExcessiveAttemptsException（登录失败次数过多）</p>
</li>
<li><p>ExpiredCredentialsException（凭证过期）等</p>
</li>
</ul>
<hr>
<h3 id="自定义Realm"><a href="#自定义Realm" class="headerlink" title="自定义Realm"></a>自定义Realm</h3><p>上边的程序使用的是Shiro自带的IniRealm，IniRealm从ini配置文件中读取用户的信息，大部分情况下需要从系统的数据库中读取用户信息，所以需要自定义realm。</p>
<h4 id="shiro提供的Realm"><a href="#shiro提供的Realm" class="headerlink" title="shiro提供的Realm"></a>shiro提供的Realm</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.yx09wf7d8v4.webp" srcset="/img/loading.gif" alt="image"></p>
<h4 id="根据认证源码认证使用的是SimpleAccountRealm"><a href="#根据认证源码认证使用的是SimpleAccountRealm" class="headerlink" title="根据认证源码认证使用的是SimpleAccountRealm"></a>根据认证源码认证使用的是SimpleAccountRealm</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.5jbvj3zl9bk0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><strong>SimpleAccountRealm</strong>的部分源码中有两个方法，一个是<strong>认证</strong>一个是<strong>授权</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SimpleAccountRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br>	<br>    ...<br>    <br>    <span class="hljs-comment">// 继承自抽象类AuthenticatingRealm 认证Realm</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken token)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>        UsernamePasswordToken upToken = (UsernamePasswordToken) token;<br>        SimpleAccount account = getUser(upToken.getUsername());<br><br>        <span class="hljs-keyword">if</span> (account != <span class="hljs-keyword">null</span>) &#123;<br><br>            <span class="hljs-keyword">if</span> (account.isLocked()) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockedAccountException(<span class="hljs-string">&quot;Account [&quot;</span> + account + <span class="hljs-string">&quot;] is locked.&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (account.isCredentialsExpired()) &#123;<br>                String msg = <span class="hljs-string">&quot;The credentials for account [&quot;</span> + account + <span class="hljs-string">&quot;] are expired&quot;</span>;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ExpiredCredentialsException(msg);<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> account;<br>    &#125;<br><br>    <span class="hljs-comment">// 继承自抽象类AuthorizingRealm 授权Realm（更往上继承自AuthenticatingRealm）</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principals)</span> </span>&#123;<br>        String username = getUsername(principals);<br>        USERS_LOCK.readLock().lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.users.get(username);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            USERS_LOCK.readLock().unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="自定义realm：继承AuthorizingRealm重写认证和授权方法"><a href="#自定义realm：继承AuthorizingRealm重写认证和授权方法" class="headerlink" title="自定义realm：继承AuthorizingRealm重写认证和授权方法"></a>自定义realm：继承AuthorizingRealm重写认证和授权方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>        String principal = (String) authenticationToken.getPrincipal();<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * 此处换做web开发，就是到根据身份信息使用JDBC/MyBatis查询数据库</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;aster&quot;</span>.equals(principal))&#123;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * SimpleAuthenticationInfo</span><br><span class="hljs-comment">             * 参数一：数据库中正确的用户名</span><br><span class="hljs-comment">             * 参数二：数据库中正确的密码</span><br><span class="hljs-comment">             * （参数三：当前Realm的名字）</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(principal, <span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-keyword">this</span>.getName());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="使用自定义Realm认证"><a href="#使用自定义Realm认证" class="headerlink" title="使用自定义Realm认证"></a>使用自定义Realm认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuthenticator</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 创建安全管理器对象</span><br>        DefaultSecurityManager securityManager = <span class="hljs-keyword">new</span> DefaultSecurityManager();<br><br>        <span class="hljs-comment">// 给安全管理器设置Realm</span><br>        securityManager.setRealm(<span class="hljs-keyword">new</span> CustomerRealm());<br><br>        <span class="hljs-comment">// 给全局安全工具类设置安全管理器</span><br>        SecurityUtils.setSecurityManager(securityManager);<br><br>        <span class="hljs-comment">// 关键对象 Subject 主体</span><br>        Subject subject = SecurityUtils.getSubject();<br><br>        <span class="hljs-comment">// 创建令牌</span><br>        UsernamePasswordToken token = <span class="hljs-keyword">new</span> UsernamePasswordToken(<span class="hljs-string">&quot;aster&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);<br><br>        <span class="hljs-comment">// 用户认证</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            subject.login(token);<br>            System.out.println(<span class="hljs-string">&quot;认证状态：&quot;</span> + subject.isAuthenticated()); <span class="hljs-comment">// 认证状态：true</span><br>        &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：用户名不存在&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException e) &#123; <span class="hljs-comment">// 无效凭证</span><br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：密码错误&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="使用MD5和Salt"><a href="#使用MD5和Salt" class="headerlink" title="使用MD5和Salt"></a>使用MD5和Salt</h3><blockquote>
<p>实际应用是将盐和散列后的值存在数据库中，自动realm从数据库取出盐和加密后的值由shiro完成密码校验</p>
<p>MD5始终生成一个16进制的32位的字符串</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.ky1atyip.webp" srcset="/img/loading.gif" alt="image"></p>
<h4 id="Shiro的MD5"><a href="#Shiro的MD5" class="headerlink" title="Shiro的MD5"></a>Shiro的MD5</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> org.apache.shiro.crypto.hash.Md5Hash;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestShiroMD5</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">// MD5</span><br>        Md5Hash md5Hash = <span class="hljs-keyword">new</span> Md5Hash(<span class="hljs-string">&quot;123&quot;</span>);<br>        System.out.println(md5Hash.toHex());<br><br>        <span class="hljs-comment">// MD5 + salt</span><br>        Md5Hash md5Hash1 = <span class="hljs-keyword">new</span> Md5Hash(<span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-string">&quot;TestS@Lt&quot;</span>);<br>        System.out.println(md5Hash1.toHex());<br><br>        <span class="hljs-comment">// MD5 + salt + Hash散列（一般是散列1024 / 2048次）</span><br>        Md5Hash md5Hash2 = <span class="hljs-keyword">new</span> Md5Hash(<span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-string">&quot;TestS@Lt&quot;</span>, <span class="hljs-number">1024</span>);<br>        System.out.println(md5Hash2.toHex());<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="自定义md5-salt的realm"><a href="#自定义md5-salt的realm" class="headerlink" title="自定义md5 + salt的realm"></a>自定义md5 + salt的realm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerMD5Realm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>        String principal = (String) authenticationToken.getPrincipal();<br>        <span class="hljs-comment">// 根据用户名查询数据库</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;aster&quot;</span>.equals(principal))&#123;<br>            String password = <span class="hljs-string">&quot;7c8945c2c6544910e592a4a52a1b6560&quot;</span>;<br>            String salt = <span class="hljs-string">&quot;TestS@Lt&quot;</span>;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 参数1：用户名</span><br><span class="hljs-comment">             * 参数2：从数据库里查到的md5 + salt + 散列之后的密码</span><br><span class="hljs-comment">             * 参数3：注册时的随机盐（格式有点怪）</span><br><span class="hljs-comment">             * 参数4：realm的名字</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(principal, password, ByteSource.Util.bytes(<span class="hljs-string">&quot;TestS@Lt&quot;</span>),<span class="hljs-keyword">this</span>.getName());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="使用md5-salt-认证"><a href="#使用md5-salt-认证" class="headerlink" title="使用md5 + salt 认证"></a>使用md5 + salt 认证</h4><p>默认的凭证匹配器CredentialsMatcher（即检查密码的方式）是直接equals来进行比较，因为采用了MD5，所以我们需要改用CredentialsMatcher的一个实现类<strong>HashedCredentialsMatcher</strong>哈希凭证匹配器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> org.apache.shiro.SecurityUtils;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.IncorrectCredentialsException;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.UnknownAccountException;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;<br><span class="hljs-keyword">import</span> org.apache.shiro.mgt.DefaultSecurityManager;<br><span class="hljs-keyword">import</span> org.apache.shiro.mgt.SecurityManager;<br><span class="hljs-keyword">import</span> org.apache.shiro.realm.text.IniRealm;<br><span class="hljs-keyword">import</span> org.apache.shiro.subject.Subject;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuthenticator</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 创建安全管理器对象</span><br>        DefaultSecurityManager securityManager = <span class="hljs-keyword">new</span> DefaultSecurityManager();<br><br>        <span class="hljs-comment">// 注入自定义realm</span><br>        CustomerMD5Realm realm = <span class="hljs-keyword">new</span> CustomerMD5Realm();<br><br>        <span class="hljs-comment">// 设置realm使用哈希凭证匹配器</span><br>        HashedCredentialsMatcher credentialsMatcher = <span class="hljs-keyword">new</span> HashedCredentialsMatcher();<br>        credentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;md5&quot;</span>);<br>        credentialsMatcher.setHashIterations(<span class="hljs-number">1024</span>);<br>        realm.setCredentialsMatcher(credentialsMatcher);<br><br>        <span class="hljs-comment">// 给安全管理器设置Realm</span><br>        securityManager.setRealm(realm);<br><br>        <span class="hljs-comment">// 给全局安全工具类设置安全管理器</span><br>        SecurityUtils.setSecurityManager(securityManager);<br><br>        <span class="hljs-comment">// 关键对象 Subject 主体</span><br>        Subject subject = SecurityUtils.getSubject();<br><br>        <span class="hljs-comment">// 创建令牌</span><br>        UsernamePasswordToken token = <span class="hljs-keyword">new</span> UsernamePasswordToken(<span class="hljs-string">&quot;aster&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);<br><br>        <span class="hljs-comment">// 用户认证</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            subject.login(token);<br>            System.out.println(<span class="hljs-string">&quot;认证状态：&quot;</span> + subject.isAuthenticated()); <span class="hljs-comment">// 认证状态：true</span><br>        &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：用户名不存在&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException e) &#123; <span class="hljs-comment">// 无效凭证</span><br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：密码错误&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<hr>
<h2 id="Shiro中的授权"><a href="#Shiro中的授权" class="headerlink" title="Shiro中的授权"></a>Shiro中的授权</h2><h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>授权，即访问控制，控制谁能访问哪些资源。主体进行身份认证后需要分配权限方可访问系统的资源，对于某些资源没有权限是无法访问的。</p>
<h3 id="关键对象"><a href="#关键对象" class="headerlink" title="关键对象"></a>关键对象</h3><p><strong>授权可简单理解为who对what(which)进行How操作：</strong></p>
<p><code>Who，即主体（Subject）</code>，主体需要访问系统中的资源。</p>
<p><code>What，即资源（Resource)</code>，如系统菜单、页面、按钮、类方法、系统商品信息等。资源包括<code>资源类型</code>和<code>资源实例</code>，比如<code>商品信息为资源类型</code>，类型为t01的商品为<code>资源实例</code>，编号为001的商品信息也属于资源实例。</p>
<p><code>How，权限/许可（Permission)</code>，规定了主体对资源的操作许可，权限离开资源没有意义，如用户查询权限、用户添加权限、某个类方法的调用权限、编号为001用户的修改权限等，通过权限可知主体对哪些资源都有哪些操作许可（权限无非就是<strong>CRUD</strong>）</p>
<h3 id="授权流程"><a href="#授权流程" class="headerlink" title="授权流程"></a>授权流程</h3><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.528vb48makw0.webp" srcset="/img/loading.gif" alt="image"></p>
<h3 id="授权方式"><a href="#授权方式" class="headerlink" title="授权方式"></a>授权方式</h3><p><strong>基于角色的访问控制</strong></p>
<p>RBAC基于角色的访问控制（Role-Based Access Control）是以角色为中心进行访问控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(subject.hasRole(<span class="hljs-string">&quot;admin&quot;</span>))&#123;<br><span class="hljs-comment">//操作什么资源</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>基于资源的访问控制</strong></p>
<p>RBAC基于资源的访问控制（Resource-Based Access Control）是以资源为中心进行访问控制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(subject.hasPermission(<span class="hljs-string">&quot;user:*:01&quot;</span>))&#123; <span class="hljs-comment">// user01是一个资源实例</span><br>    <span class="hljs-comment">//对01用户进行CRUD</span><br>&#125;<br><span class="hljs-keyword">if</span>(subject.hasPermission(<span class="hljs-string">&quot;user:update:*&quot;</span>))&#123; <span class="hljs-comment">// user是资源类型</span><br>    <span class="hljs-comment">//对用户进行U</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="权限字符串"><a href="#权限字符串" class="headerlink" title="权限字符串"></a>权限字符串</h3><p>权限字符串的规则是：<strong>资源标识符：操作：资源实例标识符</strong>，意思是对哪个资源的哪个实例具有什么操作，“:”是资源/操作/实例的分割符，权限字符串也可以使用*通配符。</p>
<p>例子：</p>
<ul>
<li>用户创建权限：user:create，或user:create:*</li>
<li>用户修改实例001的权限：user:update:001</li>
<li>用户实例001的所有权限：user:*：001</li>
</ul>
<h3 id="三种授权实现方式"><a href="#三种授权实现方式" class="headerlink" title="三种授权实现方式"></a>三种授权实现方式</h3><p><strong>编程式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Subject subject = SecurityUtils.getSubject();<br><span class="hljs-keyword">if</span>(subject.hasRole(“admin”)) &#123;<br>	<span class="hljs-comment">//有权限</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>	<span class="hljs-comment">//无权限</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>注解式</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresRoles(&quot;admin&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hello</span><span class="hljs-params">()</span> </span>&#123;<br>	<span class="hljs-comment">//有权限</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>标签式</strong></p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jsp">JSP/GSP 标签：在JSP/GSP 页面通过相应的标签完成：<br>&lt;shiro:hasRole name=<span class="hljs-string">&quot;admin&quot;</span>&gt;<br>	&lt;!—- 有权限 —-&gt;<br>&lt;/shiro:hasRole&gt;<br>注意: Thymeleaf 中使用shiro需要额外集成!<br></code></pre></td></tr></table></figure>


<h3 id="开发授权"><a href="#开发授权" class="headerlink" title="开发授权"></a>开发授权</h3><h4 id="Realm的实现"><a href="#Realm的实现" class="headerlink" title="Realm的实现"></a>Realm的实现</h4><p>一个主体有多个身份信息principals，其中有一个<strong>主身份信息PrimaryPrincipal</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerMD5Realm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;================Authorizing================&quot;</span>);<br>        String primaryPrincipal = (String) principalCollection.getPrimaryPrincipal();<br>        System.out.println(<span class="hljs-string">&quot;身份（用户名）：&quot;</span> + primaryPrincipal);<br><br>        <span class="hljs-comment">// 根据用户名（身份）查询数据库，看当前用户在数据库中有哪些角色</span><br>        <span class="hljs-comment">// ...</span><br><br>        SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="hljs-keyword">new</span> SimpleAuthorizationInfo();<br>        <span class="hljs-comment">// 将数据库中查询到的角色信息赋值给权限对象</span><br>        simpleAuthorizationInfo.addRole(<span class="hljs-string">&quot;admin&quot;</span>);<br>        simpleAuthorizationInfo.addRole(<span class="hljs-string">&quot;user&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> simpleAuthorizationInfo;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;===============Authenticating================&quot;</span>);<br>        String principal = (String) authenticationToken.getPrincipal();<br>        <span class="hljs-comment">// 根据用户名查询数据库</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;aster&quot;</span>.equals(principal))&#123;<br>            String password = <span class="hljs-string">&quot;7c8945c2c6544910e592a4a52a1b6560&quot;</span>;<br>            String salt = <span class="hljs-string">&quot;TestS@Lt&quot;</span>;<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 参数1：用户名</span><br><span class="hljs-comment">             * 参数2：从数据库里查到的md5 + salt + 散列之后的密码</span><br><span class="hljs-comment">             * 参数3：注册时的随机盐（格式有点怪）</span><br><span class="hljs-comment">             * 参数4：realm的名字</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(principal, password, ByteSource.Util.bytes(<span class="hljs-string">&quot;TestS@Lt&quot;</span>),<span class="hljs-keyword">this</span>.getName());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestAuthenticator</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 创建安全管理器对象</span><br>        DefaultSecurityManager securityManager = <span class="hljs-keyword">new</span> DefaultSecurityManager();<br><br>        <span class="hljs-comment">// 注入自定义realm</span><br>        CustomerMD5Realm realm = <span class="hljs-keyword">new</span> CustomerMD5Realm();<br><br>        <span class="hljs-comment">// 设置realm使用哈希凭证匹配器</span><br>        HashedCredentialsMatcher credentialsMatcher = <span class="hljs-keyword">new</span> HashedCredentialsMatcher();<br>        credentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;md5&quot;</span>);<br>        credentialsMatcher.setHashIterations(<span class="hljs-number">1024</span>);<br>        realm.setCredentialsMatcher(credentialsMatcher);<br><br>        <span class="hljs-comment">// 给安全管理器设置Realm</span><br>        securityManager.setRealm(realm);<br><br>        <span class="hljs-comment">// 给全局安全工具类设置安全管理器</span><br>        SecurityUtils.setSecurityManager(securityManager);<br><br>        <span class="hljs-comment">// 关键对象 Subject 主体</span><br>        Subject subject = SecurityUtils.getSubject();<br><br>        <span class="hljs-comment">// 创建令牌</span><br>        UsernamePasswordToken token = <span class="hljs-keyword">new</span> UsernamePasswordToken(<span class="hljs-string">&quot;aster&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);<br><br>        <span class="hljs-comment">// 用户认证</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            subject.login(token);<br>            System.out.println(<span class="hljs-string">&quot;登录成功&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：用户名不存在&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException e) &#123; <span class="hljs-comment">// 无效凭证</span><br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;认证失败：密码错误&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// ⭐⭐⭐认证用户进行授权⭐⭐⭐</span><br>        <span class="hljs-keyword">if</span>(subject.isAuthenticated()) &#123; <span class="hljs-comment">// 如果主体（用户）认证通过</span><br>            System.out.println(<span class="hljs-string">&quot;是否拥有admin权限：&quot;</span> + subject.hasRole(<span class="hljs-string">&quot;admin&quot;</span>));<br>        &#125;<br><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">===============<span class="hljs-attribute">Authenticating</span>================<br>登录成功<br>================<span class="hljs-attribute">Authorizing</span>==================<br>身份（用户名）：aster<br>是否拥有admin权限：<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>



<p>当然，也可以一口气添加多个角色，或者同时要求具有多个角色</p>
<ul>
<li>hasAllRoles()要求同时具有多个角色</li>
<li>hasRoles()返回布尔数组</li>
</ul>
<blockquote>
<p>善用<code>Arrays.asList()</code>临时生成一个Collection</p>
</blockquote>
<p>基于权限的访问控制暂略</p>
<h2 id="整合SpringBoot"><a href="#整合SpringBoot" class="headerlink" title="整合SpringBoot"></a>整合SpringBoot</h2><h3 id="整合思路"><a href="#整合思路" class="headerlink" title="整合思路"></a>整合思路</h3><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.5ei6o7zo4ig0.webp" srcset="/img/loading.gif" alt="image"></p>
<h3 id="创建springboot项目"><a href="#创建springboot项目" class="headerlink" title="创建springboot项目"></a>创建springboot项目</h3><blockquote>
<p>小知识：许多IDE都支持<code>! + Tab</code>补全常见前端代码</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.5zat23tvsvc0.webp" srcset="/img/loading.gif" alt="image"></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">shiro</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.4xv88jspk7s0.webp" srcset="/img/loading.gif" alt="image"></p>
<p>简简单单搭个环境咯~因为放假很闲所以全给粘上来（</p>
<h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="配置Shiro环境"><a href="#配置Shiro环境" class="headerlink" title="配置Shiro环境"></a>配置Shiro环境</h3><p>（结合本节一开始的图来记忆，对应图里的三部分）</p>
<h4 id="创建配置类"><a href="#创建配置类" class="headerlink" title="创建配置类"></a>创建配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.config;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShiroConfig</span> </span>&#123;<br><br>    <span class="hljs-comment">// 1.创建ShiroFilter</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title">getShiroFilterFactoryBean</span><span class="hljs-params">()</span> </span>&#123;...&#125;<br><br>    <span class="hljs-comment">// 2.创建安全管理器SecurityManager</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DefaultWebSecurityManager <span class="hljs-title">getDefaultWebSecurityManager</span><span class="hljs-params">()</span> </span>&#123;...&#125;<br><br>    <span class="hljs-comment">// 3.创建自定义Realm</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Realm <span class="hljs-title">getRealm</span><span class="hljs-params">()</span> </span>&#123;...&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="配置ShiroFilterFactoryBean"><a href="#配置ShiroFilterFactoryBean" class="headerlink" title="配置ShiroFilterFactoryBean"></a>配置ShiroFilterFactoryBean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.创建ShiroFilter</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title">getShiroFilterFactoryBean</span><span class="hljs-params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> </span>&#123; <span class="hljs-comment">// &lt;- 参数自动注入哦</span><br>    ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="hljs-keyword">new</span> ShiroFilterFactoryBean();<br>    <span class="hljs-comment">// 给Filter设置安全管理器</span><br>    shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager);<br>    <span class="hljs-keyword">return</span> shiroFilterFactoryBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="配置WebSecurityManager"><a href="#配置WebSecurityManager" class="headerlink" title="配置WebSecurityManager"></a>配置WebSecurityManager</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//2.创建安全管理器SecurityManager</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> DefaultWebSecurityManager <span class="hljs-title">getDefaultWebSecurityManager</span><span class="hljs-params">(Realm realm)</span> </span>&#123; <span class="hljs-comment">// &lt;- 注意这里带了“Web”</span><br>    DefaultWebSecurityManager defaultWebSecurityManager = <span class="hljs-keyword">new</span> DefaultWebSecurityManager();<br>    <span class="hljs-comment">// 给安全管理器设置Realm</span><br>    defaultWebSecurityManager.setRealm(realm);<br>    <span class="hljs-keyword">return</span> defaultWebSecurityManager;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="创建自定义Realm"><a href="#创建自定义Realm" class="headerlink" title="创建自定义Realm"></a>创建自定义Realm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.realms;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-comment">// 自定义Realm</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="配置自定义Realm"><a href="#配置自定义Realm" class="headerlink" title="配置自定义Realm"></a>配置自定义Realm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//3.创建自定义Realm</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Realm <span class="hljs-title">getRealm</span><span class="hljs-params">()</span> </span>&#123;<br>    CustomerRealm customerRealm = <span class="hljs-keyword">new</span> CustomerRealm();<br>    <span class="hljs-keyword">return</span> customerRealm;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.62npydydg580.webp" srcset="/img/loading.gif" alt="image"></p>
<ul>
<li>注意:<ul>
<li><strong>默认在配置好shiro环境后默认环境中没有对项目中任何资源进行权限控制，所有现在项目中所有资源都可以通过路径访问</strong></li>
</ul>
</li>
</ul>
<h4 id="加入权限控制"><a href="#加入权限控制" class="headerlink" title="加入权限控制"></a>加入权限控制</h4><p>修改ShiroFilterFactoryBean配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.创建ShiroFilter</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title">getShiroFilterFactoryBean</span><span class="hljs-params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> </span>&#123;<br>ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="hljs-keyword">new</span> ShiroFilterFactoryBean();<br><span class="hljs-comment">// 给Filter设置安全管理器</span><br>shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager);<br><span class="hljs-comment">// 配置系统受限、公共资源</span><br>HashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>map.put(<span class="hljs-string">&quot;/index&quot;</span>, <span class="hljs-string">&quot;authc&quot;</span>); <span class="hljs-comment">// authc: 请求这个资源需要认证和授权</span><br>shiroFilterFactoryBean.setFilterChainDefinitionMap(map);<br><span class="hljs-keyword">return</span> shiroFilterFactoryBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果是**/****，则代表拦截项目中一切资源，一般之后都是写/**，所以用下面这种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">map.put(<span class="hljs-string">&quot;/**&quot;</span>, <span class="hljs-string">&quot;authc&quot;</span>);<br>map.put(<span class="hljs-string">&quot;/user/**&quot;</span>, <span class="hljs-string">&quot;anon&quot;</span>); <span class="hljs-comment">// 登录、注册等</span><br>map.put(<span class="hljs-string">&quot;/login&quot;</span>, <span class="hljs-string">&quot;anon&quot;</span>);<br>map.put(<span class="hljs-string">&quot;/register&quot;</span>, <span class="hljs-string">&quot;anon&quot;</span>);<br></code></pre></td></tr></table></figure>

<p><strong>authc</strong>代表shiro中的一个filter的别名，详细内容看下面的列表</p>
<p>重启项目访问index，发现报错了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.3rumhq20leg0.webp" srcset="/img/loading.gif" alt="image"></p>
<p>这是为什么呢？因为如果无权限，Shiro默认跳转到login.jsp，我们可以自己修改</p>
<h4 id="自定义自动跳转的认证路径"><a href="#自定义自动跳转的认证路径" class="headerlink" title="自定义自动跳转的认证路径"></a>自定义自动跳转的认证路径</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title">getShiroFilterFactoryBean</span><span class="hljs-params">(DefaultWebSecurityManager defaultWebSecurityManager)</span> </span>&#123;<br>    ...<br>    <span class="hljs-comment">// 设置认证界面路径</span><br>    shiroFilterFactoryBean.setLoginUrl(<span class="hljs-string">&quot;/login&quot;</span>); <span class="hljs-comment">// （当然我偷偷写好了Controller）</span><br>    <span class="hljs-keyword">return</span> shiroFilterFactoryBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6piaew529xw0.webp" srcset="/img/loading.gif" alt="image"></p>
<h3 id="常见过滤器"><a href="#常见过滤器" class="headerlink" title="常见过滤器"></a>常见过滤器</h3><ul>
<li>注意: <strong>shiro提供和多个默认的过滤器，我们可以用这些过滤器来配置控制指定url的权限：</strong></li>
</ul>
<table>
<thead>
<tr>
<th>配置缩写</th>
<th>对应的过滤器</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td><strong>anon</strong></td>
<td>AnonymousFilter</td>
<td align="left">指定url可以匿名访问</td>
</tr>
<tr>
<td><strong>authc</strong></td>
<td>FormAuthenticationFilter</td>
<td align="left">指定url需要form表单登录，默认会从请求中获取<code>username</code>、<code>password</code>,<code>rememberMe</code>等参数并尝试登录，如果登录不了就会跳转到loginUrl配置的路径。我们也可以用这个过滤器做默认的登录逻辑，但是一般都是我们自己在控制器写登录逻辑的，自己写的话出错返回的信息都可以定制嘛。</td>
</tr>
<tr>
<td>authcBasic</td>
<td>BasicHttpAuthenticationFilter</td>
<td align="left">指定url需要basic登录</td>
</tr>
<tr>
<td>logout</td>
<td>LogoutFilter</td>
<td align="left">登出过滤器，配置指定url就可以实现退出功能，非常方便</td>
</tr>
<tr>
<td>noSessionCreation</td>
<td>NoSessionCreationFilter</td>
<td align="left">禁止创建会话</td>
</tr>
<tr>
<td><strong>perms</strong></td>
<td>PermissionsAuthorizationFilter</td>
<td align="left">需要指定权限才能访问</td>
</tr>
<tr>
<td>port</td>
<td>PortFilter</td>
<td align="left">需要指定端口才能访问</td>
</tr>
<tr>
<td>rest</td>
<td>HttpMethodPermissionFilter</td>
<td align="left">将http请求方法转化成相应的动词来构造一个权限字符串，这个感觉意义不大，有兴趣自己看源码的注释</td>
</tr>
<tr>
<td><strong>roles</strong></td>
<td>RolesAuthorizationFilter</td>
<td align="left">需要指定角色才能访问</td>
</tr>
<tr>
<td>ssl</td>
<td>SslFilter</td>
<td align="left">需要https请求才能访问</td>
</tr>
<tr>
<td>user</td>
<td>UserFilter</td>
<td align="left">需要已登录或“记住我”的用户才能访问</td>
</tr>
</tbody></table>
<h3 id="认证实现"><a href="#认证实现" class="headerlink" title="认证实现"></a>认证实现</h3><h4 id="在login-html中开发认证界面"><a href="#在login-html中开发认证界面" class="headerlink" title="在login.html中开发认证界面"></a>在login.html中开发认证界面</h4><blockquote>
<p>HTML5规范中，自闭合标签不加斜杠（如<code>&lt;input&gt; &lt;br&gt;</code>，但兼容加斜杠的写法）</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.13qsoeiciu00.webp" srcset="/img/loading.gif" alt="image"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户登录<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/user/login&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    用户名：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    密码：  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;登录&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="开发controller"><a href="#开发controller" class="headerlink" title="开发controller"></a>开发controller</h4><p><strong>注意：</strong>在之前的本地开发中，需要给SecurityUtils设置安全管理器SecurityManager，然后再用SecurityUtils获取subject，但是在<strong>web环境中</strong>，只要在config中注入了安全管理器，Shiro就会<strong>自动</strong>给SecurityUtils设置安全管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.controller;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 用来处理身份认证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> username</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> password</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(&quot;login&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">login</span><span class="hljs-params">(String username, String password)</span> </span>&#123;<br>        <span class="hljs-comment">// 获取主体对象</span><br>        Subject subject = SecurityUtils.getSubject();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            subject.login(<span class="hljs-keyword">new</span> UsernamePasswordToken(username, password));<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index.html&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;用户名错误！&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;密码错误！&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login.html&quot;</span>;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>在认证过程中使用subject.login进行认证</strong></p>
<h4 id="开发realm中返回静态数据-未连接数据库"><a href="#开发realm中返回静态数据-未连接数据库" class="headerlink" title="开发realm中返回静态数据(未连接数据库)"></a>开发realm中返回静态数据(未连接数据库)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken token)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br>		System.out.println(<span class="hljs-string">&quot;===============Authenticating================&quot;</span>);<br>        String principal = (String) token.getPrincipal();<br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;xiaochen&quot;</span>.equals(principal))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(principal,<span class="hljs-string">&quot;123&quot;</span>,<span class="hljs-keyword">this</span>.getName());<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="启动项目以realm中定义静态数据进行认证"><a href="#启动项目以realm中定义静态数据进行认证" class="headerlink" title="启动项目以realm中定义静态数据进行认证"></a>启动项目以realm中定义静态数据进行认证</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6du55sr97ao0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6ebrnvekuj40.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.62npydydg580.webp" srcset="/img/loading.gif" alt="image"></p>
<p>没有md5和随机盐的认证功能就实现啦</p>
<h3 id="退出认证"><a href="#退出认证" class="headerlink" title="退出认证"></a>退出认证</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br>    ...<br>    <span class="hljs-meta">@RequestMapping(&quot;logout&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">logout</span><span class="hljs-params">()</span> </span>&#123;<br>        Subject subject = SecurityUtils.getSubject();<br>        subject.logout();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login.html&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>系统主页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/user/logout&quot;</span>&gt;</span>注销<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="MD5、Salt的认证实现"><a href="#MD5、Salt的认证实现" class="headerlink" title="MD5、Salt的认证实现"></a>MD5、Salt的认证实现</h3><h4 id="开发数据库注册"><a href="#开发数据库注册" class="headerlink" title="开发数据库注册"></a>开发数据库注册</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户注册<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/user/register&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span>&gt;</span><br>    用户名：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    密码：  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;注册&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h4 id="创建数据表结构"><a href="#创建数据表结构" class="headerlink" title="创建数据表结构"></a>创建数据表结构</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.3jqkwe5z8va0.webp" srcset="/img/loading.gif" alt="image"></p>
<h4 id="引入依赖-1"><a href="#引入依赖-1" class="headerlink" title="引入依赖"></a>引入依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- MyBatis --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- MySQL --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- Druid --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="配置application-yaml"><a href="#配置application-yaml" class="headerlink" title="配置application.yaml"></a>配置application.yaml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">shiro</span><br>  <span class="hljs-attr">mvc:</span><br>    <span class="hljs-attr">view:</span><br>      <span class="hljs-attr">prefix:</span> <span class="hljs-string">/</span><br>      <span class="hljs-attr">suffix:</span> <span class="hljs-string">.html</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/shiro</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span><br><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure>

<h4 id="创建entity"><a href="#创建entity" class="headerlink" title="创建entity"></a>创建entity</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.2cod2sngyjy8.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6ueccer3xho0.webp" srcset="/img/loading.gif" alt="image"></p>
<h4 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h4><p>（被逆天期末月搞得好久没写代码了……凭感觉写一写）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.mapper;<br><br><span class="hljs-keyword">import</span> com.aster.springbootshiro.domain.User;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;<br><br><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">User</span>&gt; </span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<h4 id="开发Service"><a href="#开发Service" class="headerlink" title="开发Service"></a>开发Service</h4><blockquote>
<p>p.s. <strong>@Transactional注解</strong>是Spring声明式事务管理的一种注解方法</p>
<p>@Transactional 可以作用于接口、接口方法、类以及类方法上。当作用于类上时，该类的所有 public 方法将都具有该类型的事务属性，同时，我们也可以在方法级别使用该标注来覆盖类级别的定义</p>
<p>虽然 @Transactional 注解可以作用于接口、接口方法、类以及类方法上，但是 Spring 建议不要在接口或者接口方法上使用该注解，因为这只有在使用基于接口的代理时它才会生效。另外， @Transactional 注解应该只被应用到 public 方法上，这是由 Spring AOP 的本质决定的。如果你在 protected、private 或者默认可见性的方法上使用 @Transactional 注解，这将被忽略，也不会抛出任何异常</p>
<p>默认情况下，只有来自外部的方法调用才会被AOP代理捕获，也就是，类内部方法调用本类内部的其他方法并不会引起事务行为，即使被调用方法使用@Transactional注解进行修饰</p>
<p>一般在有<strong>增删改</strong>操作的方法上加上@Transactional</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.service.impl;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(User user)</span> </span>&#123;<br>        <span class="hljs-comment">// 生成随机盐</span><br>        String salt = SaltUtils.getSalt(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">// 设置盐</span><br>        user.setSalt(salt);<br>        <span class="hljs-comment">// 密码加密</span><br>        Md5Hash md5Hash = <span class="hljs-keyword">new</span> Md5Hash(user.getPassword(), salt, <span class="hljs-number">1024</span>);<br>        user.setPassword(md5Hash.toHex());<br>        <span class="hljs-comment">// 保存新用户</span><br>        userMapper.insert(user);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="创建salt工具类"><a href="#创建salt工具类" class="headerlink" title="创建salt工具类"></a>创建salt工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.utils;<br><br><span class="hljs-keyword">import</span> java.util.Random;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SaltUtils</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getSalt</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>        <span class="hljs-keyword">char</span>[] chars = <span class="hljs-string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890!@#$%^&amp;*()&quot;</span>.toCharArray();<br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>            <span class="hljs-keyword">char</span> aChar = chars[<span class="hljs-keyword">new</span> Random().nextInt(chars.length)];<br>            sb.append(aChar);<br>        &#125;<br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="开发Controller"><a href="#开发Controller" class="headerlink" title="开发Controller"></a>开发Controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;register&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">register</span><span class="hljs-params">(User user)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            userService.register(user);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login.html&quot;</span>; <span class="hljs-comment">// 注册成功，跳转登录</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/register.html&quot;</span>; <span class="hljs-comment">// 注册失败，继续尝试</span><br>        &#125;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="启动项目进行注册测试"><a href="#启动项目进行注册测试" class="headerlink" title="启动项目进行注册测试"></a>启动项目进行注册测试</h4><p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.3hjm1p14f1q0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.7c62acppqjk0.webp" srcset="/img/loading.gif" alt="image"></p>
<h4 id="开发数据库认证"><a href="#开发数据库认证" class="headerlink" title="开发数据库认证"></a>开发数据库认证</h4><h4 id="开发Service-1"><a href="#开发Service-1" class="headerlink" title="开发Service"></a>开发Service</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.service.impl;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    ...<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findByUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="hljs-keyword">new</span> LambdaQueryWrapper&lt;&gt;();<br>        queryWrapper.eq(User::getUsername, username);<br>        <span class="hljs-comment">//增加查询效率，只查询一条</span><br>        queryWrapper.last(<span class="hljs-string">&quot;limit 1&quot;</span>);<br>        <span class="hljs-keyword">return</span> userMapper.selectOne(queryWrapper);<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="修改自定义realm"><a href="#修改自定义realm" class="headerlink" title="修改自定义realm"></a>修改自定义realm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.realms;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-comment">// 自定义Realm</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br><br>        System.out.println(<span class="hljs-string">&quot;===============Authenticating================&quot;</span>);<br>        String principal = (String) authenticationToken.getPrincipal();<br>        <br>        <span class="hljs-comment">// 从数据库中查询用户名对应的user</span><br>        User user = userService.findByUsername(principal);<br><br>        <span class="hljs-keyword">if</span>(!ObjectUtils.isEmpty(user)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), ByteSource.Util.bytes(user.getSalt()), <span class="hljs-keyword">this</span>.getName());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="修改ShiroConfig中Realm使用的凭证匹配器以及Hash散列"><a href="#修改ShiroConfig中Realm使用的凭证匹配器以及Hash散列" class="headerlink" title="修改ShiroConfig中Realm使用的凭证匹配器以及Hash散列"></a>修改ShiroConfig中Realm使用的凭证匹配器以及Hash散列</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.config;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShiroConfig</span> </span>&#123;<br><br>    ...<br><br>    <span class="hljs-comment">//3.创建自定义Realm</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Realm <span class="hljs-title">getRealm</span><span class="hljs-params">()</span> </span>&#123;<br>        CustomerRealm customerRealm = <span class="hljs-keyword">new</span> CustomerRealm();<br>        <span class="hljs-comment">//设置hashed凭证匹配器</span><br>        HashedCredentialsMatcher credentialsMatcher = <span class="hljs-keyword">new</span> HashedCredentialsMatcher();<br>        <span class="hljs-comment">//设置md5加密</span><br>        credentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;md5&quot;</span>);<br>        <span class="hljs-comment">//设置散列次数</span><br>        credentialsMatcher.setHashIterations(<span class="hljs-number">1024</span>);<br>        customerRealm.setCredentialsMatcher(credentialsMatcher);<br>        <span class="hljs-keyword">return</span> customerRealm;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="授权实现"><a href="#授权实现" class="headerlink" title="授权实现"></a>授权实现</h3><h4 id="标签式（略）"><a href="#标签式（略）" class="headerlink" title="标签式（略）"></a>标签式（略）</h4><p>不怎么用</p>
<h4 id="代码式"><a href="#代码式" class="headerlink" title="代码式"></a>代码式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span>(subject.hasRole(<span class="hljs-string">&quot;xxx&quot;</span>)) ...<br></code></pre></td></tr></table></figure>

<h4 id="注解式（方法调用授权）"><a href="#注解式（方法调用授权）" class="headerlink" title="注解式（方法调用授权）"></a>注解式（方法调用授权）</h4><ul>
<li>@RequiresRoles                用来基于角色进行授权</li>
<li>@RequiresPermissions    用来基于权限进行授权</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresRoles(value=&#123;&quot;admin&quot;, &quot;user&quot;&#125;)</span> <span class="hljs-comment">// 用来判断角色  同时具有 admin user</span><br><span class="hljs-meta">@RequiresPermissions(&quot;user:update:01&quot;)</span> <span class="hljs-comment">//用来判断权限字符串</span><br><span class="hljs-meta">@RequestMapping(&quot;test&quot;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">()</span></span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h4 id="授权数据持久化（设计数据库）"><a href="#授权数据持久化（设计数据库）" class="headerlink" title="授权数据持久化（设计数据库）"></a>授权数据持久化（设计数据库）</h4><p>用户和角色，角色和权限都是多对多的</p>
<p>但是实际数据库操作中一般是进行一对多的操作，因此需要设立两个中间表</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.2pqto9mw08u0.webp" srcset="/img/loading.gif" alt="image"></p>
<p>虽然我们知道有外键这个东西，但是实际应用中不在数据库中写这个，因为有不少问题</p>
<p>因为我很懒，所以学习阶段就先只用一层用户-权限吧（逃）</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.7afqhmv2g2w0.webp" srcset="/img/loading.gif" alt="image"></p>
<h4 id="创建Mapper"><a href="#创建Mapper" class="headerlink" title="创建Mapper"></a>创建Mapper</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRoleMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">UserRole</span>&gt; </span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RoleMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">Role</span>&gt; </span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Service实现"><a href="#Service实现" class="headerlink" title="Service实现"></a>Service实现</h4><p>就都写在UserService里了</p>
<p>放个完整版吧</p>
<blockquote>
<p>顺便，研究了研究，那个selectOne只是返回一条，实际查询的时候不一定只查了一条，所以limit 1应该是有用的（懒得去测试用时或者看源码了）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.service.impl;<br><br><span class="hljs-keyword">import</span> com.aster.springbootshiro.domain.Role;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.domain.User;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.domain.UserRole;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.mapper.RoleMapper;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.mapper.UserMapper;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.mapper.UserRoleMapper;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.service.UserService;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.utils.SaltUtils;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;<br><span class="hljs-keyword">import</span> org.apache.shiro.crypto.hash.Md5Hash;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserRoleMapper userRoleMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoleMapper roleMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">register</span><span class="hljs-params">(User user)</span> </span>&#123;<br>        <span class="hljs-comment">// 生成随机盐</span><br>        String salt = SaltUtils.getSalt(<span class="hljs-number">8</span>);<br>        <span class="hljs-comment">// 设置盐</span><br>        user.setSalt(salt);<br>        <span class="hljs-comment">// 密码加密</span><br>        Md5Hash md5Hash = <span class="hljs-keyword">new</span> Md5Hash(user.getPassword(), salt, <span class="hljs-number">1024</span>);<br>        user.setPassword(md5Hash.toHex());<br>        <span class="hljs-comment">// 保存新用户</span><br>        userMapper.insert(user);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">findByUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br>        LambdaQueryWrapper&lt;User&gt; queryWrapper = <span class="hljs-keyword">new</span> LambdaQueryWrapper&lt;&gt;();<br>        queryWrapper.eq(User::getUsername, username);<br>        <span class="hljs-comment">//增加查询效率，只查询一条</span><br>        queryWrapper.last(<span class="hljs-string">&quot;limit 1&quot;</span>);<br>        <span class="hljs-keyword">return</span> userMapper.selectOne(queryWrapper);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Role&gt; <span class="hljs-title">findRolesByUsername</span><span class="hljs-params">(String username)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 根据用户名查询用户</span><br>        User user = findByUsername(username);<br><br>        <span class="hljs-comment">// 根据用户id查询拥有的角色id</span><br>        LambdaQueryWrapper&lt;UserRole&gt; queryWrapper = <span class="hljs-keyword">new</span> LambdaQueryWrapper&lt;&gt;();<br>        queryWrapper.eq(UserRole::getUserid, user.getId());<br>        List&lt;UserRole&gt; userRoleList = userRoleMapper.selectList(queryWrapper);<br><br>        <span class="hljs-comment">// 根据角色id查询角色名</span><br>        List&lt;Role&gt; roleList = <span class="hljs-keyword">new</span> ArrayList&lt;Role&gt;();<br>        <span class="hljs-keyword">for</span> (UserRole userRole : userRoleList) &#123;<br>            LambdaQueryWrapper&lt;Role&gt; queryWrapper1 = <span class="hljs-keyword">new</span> LambdaQueryWrapper&lt;&gt;();<br>            queryWrapper1.eq(Role::getId, userRole.getRoleid());<br>            queryWrapper.last(<span class="hljs-string">&quot;limit 1&quot;</span>);<br>            roleList.add(roleMapper.selectOne(queryWrapper1));<br>        &#125;<br>        <span class="hljs-keyword">return</span> roleList;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="修改自定义realm-1"><a href="#修改自定义realm-1" class="headerlink" title="修改自定义realm"></a>修改自定义realm</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.realms;<br><br><span class="hljs-keyword">import</span> com.aster.springbootshiro.domain.Role;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.domain.User;<br><span class="hljs-keyword">import</span> com.aster.springbootshiro.service.UserService;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.AuthenticationException;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.AuthenticationToken;<br><span class="hljs-keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;<br><span class="hljs-keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;<br><span class="hljs-keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;<br><span class="hljs-keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;<br><span class="hljs-keyword">import</span> org.apache.shiro.subject.PrincipalCollection;<br><span class="hljs-keyword">import</span> org.apache.shiro.util.ByteSource;<br><span class="hljs-keyword">import</span> org.apache.shiro.util.CollectionUtils;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.util.ObjectUtils;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">// 自定义Realm</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizingRealm</span> </span>&#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> </span>&#123;<br><br>        <span class="hljs-comment">// 获取身份信息</span><br>        String primaryPrincipal = (String) principalCollection.getPrimaryPrincipal();<br><br>        <span class="hljs-comment">// 根据主身份信息获取角色信息</span><br>        User user = userService.findByUsername(primaryPrincipal);<br><br>        <span class="hljs-comment">// 授权</span><br>        List&lt;Role&gt; roles = userService.findRolesByUsername(user.getUsername());<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(roles)) &#123; <span class="hljs-comment">// 写得有点啰嗦（逃）</span><br>            SimpleAuthorizationInfo simpleAuthorizationInfo = <span class="hljs-keyword">new</span> SimpleAuthorizationInfo();<br>            <span class="hljs-comment">// 这里是Lambda表达式哦</span><br>            roles.forEach(role -&gt; &#123;<br>                simpleAuthorizationInfo.addRole(role.getName());<br>            &#125;);<br>            <span class="hljs-keyword">return</span> simpleAuthorizationInfo;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br><br>        String principal = (String) authenticationToken.getPrincipal();<br>        <span class="hljs-comment">// 从数据库中查询用户名对应的user</span><br>        User user = userService.findByUsername(principal);<br><br>        <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(user)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), ByteSource.Util.bytes(user.getSalt()), <span class="hljs-keyword">this</span>.getName());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="写个小测试"><a href="#写个小测试" class="headerlink" title="写个小测试"></a>写个小测试</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>主页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/user/logout&quot;</span>&gt;</span>注销<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/test/view&quot;</span>&gt;</span>商品查看<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/test/manage&quot;</span>&gt;</span>商品管理<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.controller;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;test&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;<br><br>    <span class="hljs-meta">@RequiresRoles(&#123;&quot;admin&quot;&#125;)</span><br>    <span class="hljs-meta">@RequestMapping(&quot;manage&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">manage</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;假装进入了管理页面&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequiresRoles(&#123;&quot;admin&quot;, &quot;user&quot;&#125;)</span><br>    <span class="hljs-meta">@RequestMapping(&quot;view&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">view</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;假装进入了浏览页面&quot;</span>;<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>aster是管理员和普通用户，lotus仅仅是普通用户</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6du55sr97ao0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.5r8mtcqrws00.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6ncln46xpkg0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.1no3uii9vji8.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.4liyj5yng2o0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6ncln46xpkg0.webp" srcset="/img/loading.gif" alt="image"></p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.11huxinjbqhs.webp" srcset="/img/loading.gif" alt="image"></p>
<p><strong>（我超！Shiro真方便！）</strong></p>
<hr>
<h3 id="使用CacheManager"><a href="#使用CacheManager" class="headerlink" title="使用CacheManager"></a>使用CacheManager</h3><h4 id="Cache的作用"><a href="#Cache的作用" class="headerlink" title="Cache的作用"></a>Cache的作用</h4><ul>
<li>Cache 缓存: <strong>计算机内存中一段数据</strong>  </li>
<li>作用: <strong>用来减轻DB的访问压力,从而提高系统的查询效率</strong></li>
<li>流程: </li>
</ul>
<p>![image-20200530090656417](Shiro 实战教程.assets/image-20200530090656417.png)</p>
<h4 id="使用默认EhCache实现缓存"><a href="#使用默认EhCache实现缓存" class="headerlink" title="使用默认EhCache实现缓存"></a>使用默认EhCache实现缓存</h4><h5 id="引入依赖-2"><a href="#引入依赖-2" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--引入shiro和ehcache--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h5 id="开启缓存"><a href="#开启缓存" class="headerlink" title="开启缓存"></a>开启缓存</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//3.创建自定义realm</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Realm <span class="hljs-title">getRealm</span><span class="hljs-params">()</span></span>&#123;<br>    CustomerRealm customerRealm = <span class="hljs-keyword">new</span> CustomerRealm();<br>    <span class="hljs-comment">//修改凭证校验匹配器</span><br>    HashedCredentialsMatcher credentialsMatcher = <span class="hljs-keyword">new</span> HashedCredentialsMatcher();<br>    <span class="hljs-comment">//设置加密算法为md5</span><br>    credentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;MD5&quot;</span>);<br>    <span class="hljs-comment">//设置散列次数</span><br>    credentialsMatcher.setHashIterations(<span class="hljs-number">1024</span>);<br>    customerRealm.setCredentialsMatcher(credentialsMatcher);<br><br>    <span class="hljs-comment">//开启缓存管理器</span><br>    customerRealm.setCachingEnabled(<span class="hljs-keyword">true</span>);<br>    customerRealm.setAuthorizationCachingEnabled(<span class="hljs-keyword">true</span>);<br>    customerRealm.setAuthorizationCachingEnabled(<span class="hljs-keyword">true</span>);<br>    customerRealm.setCacheManager(<span class="hljs-keyword">new</span> EhCacheManager());<br>    <span class="hljs-keyword">return</span> customerRealm;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="启动刷新页面进行测试"><a href="#启动刷新页面进行测试" class="headerlink" title="启动刷新页面进行测试"></a>启动刷新页面进行测试</h5><ul>
<li>注意:如果控制台没有任何sql展示说明缓存已经开启</li>
</ul>
<h4 id="使用Redis实现缓存"><a href="#使用Redis实现缓存" class="headerlink" title="使用Redis实现缓存"></a>使用Redis实现缓存</h4><p>虽然收藏夹里有但姑且也在这放一遍<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4a5ebe3c6dbd">Windows的Redis安装配置</a></p>
<p>配完路径后输入redis-cli就直接连接进redis了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.j2i9bwz25oo.webp" srcset="/img/loading.gif" alt="image"></p>
<h5 id="引入依赖-3"><a href="#引入依赖-3" class="headerlink" title="引入依赖"></a>引入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Redis --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h5 id="配置redis连接"><a href="#配置redis连接" class="headerlink" title="配置redis连接"></a>配置redis连接</h5><p>其实默认不配也是下面这些</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring</span>:<span class="hljs-string"></span><br>  <span class="hljs-attr">redis</span>:<span class="hljs-string"></span><br>    <span class="hljs-attr">port</span>: <span class="hljs-string">6379</span><br>    <span class="hljs-attr">host</span>: <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">database</span>: <span class="hljs-string">0</span><br></code></pre></td></tr></table></figure>


<h5 id="实现RedisCacheManager"><a href="#实现RedisCacheManager" class="headerlink" title="实现RedisCacheManager"></a>实现RedisCacheManager</h5><p>（Shiro自带的EhCacheManager就是CacheManager的一个实现类）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.cache;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisCacheManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CacheManager</span> </span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;K, V&gt; <span class="hljs-function">Cache&lt;K, V&gt; <span class="hljs-title">getCache</span><span class="hljs-params">(String cacheName)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;缓存名称: &quot;</span> + cacheName);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RedisCache&lt;&gt;(cacheName);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h5 id="实现RedisCache"><a href="#实现RedisCache" class="headerlink" title="实现RedisCache"></a>实现RedisCache</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.cache;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-comment">// 自定义RedisCache缓存实现</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisCache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String cacheName;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">get</span><span class="hljs-params">(K k)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;获取缓存:&quot;</span> + k);<br>        <span class="hljs-keyword">return</span> (V) getRedisTemplate().opsForHash().get(cacheName, k.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K k, V v)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;设置缓存key: &quot;</span> + k + <span class="hljs-string">&quot; value:&quot;</span> + v);<br>        getRedisTemplate().opsForHash().put(cacheName, k.toString(), v);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">remove</span><span class="hljs-params">(K k)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        <span class="hljs-keyword">return</span> (V) getRedisTemplate().opsForHash().delete(<span class="hljs-keyword">this</span>.cacheName, k.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        getRedisTemplate().delete(<span class="hljs-keyword">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().size(<span class="hljs-keyword">this</span>.cacheName).intValue();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;K&gt; <span class="hljs-title">keys</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().keys(<span class="hljs-keyword">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;V&gt; <span class="hljs-title">values</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().values(<span class="hljs-keyword">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-comment">//封装获取redisTemplate</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> RedisTemplate <span class="hljs-title">getRedisTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> StringRedisSerializer());<br>        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> StringRedisSerializer());<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RedisCache</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RedisCache</span><span class="hljs-params">(String cacheName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.cacheName = cacheName;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="开启缓存-1"><a href="#开启缓存-1" class="headerlink" title="开启缓存"></a>开启缓存</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//3.创建自定义realm</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Realm <span class="hljs-title">getRealm</span><span class="hljs-params">()</span></span>&#123;<br>     <br>    ...<br><br>    <span class="hljs-comment">// 开启缓存管理器</span><br>    customerRealm.setCacheManager(<span class="hljs-keyword">new</span> RedisCacheManager());<br>    customerRealm.setCachingEnabled(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// 开启全局缓存</span><br>    customerRealm.setAuthenticationCachingEnabled(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// 开启认证缓存</span><br>    customerRealm.setAuthenticationCacheName(<span class="hljs-string">&quot;AuthenticationCache&quot;</span>);<br>    customerRealm.setAuthorizationCachingEnabled(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// 开启授权缓存</span><br>    customerRealm.setAuthorizationCacheName(<span class="hljs-string">&quot;AuthorizationCache&quot;</span>);<br>    <br>    <span class="hljs-keyword">return</span> customerRealm;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="自定义salt实现序列化"><a href="#自定义salt实现序列化" class="headerlink" title="自定义salt实现序列化"></a>自定义salt实现序列化</h5><p>由于shiro中提供的simpleByteSource实现没有实现序列化，我们需要改用自己写的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.salt;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-comment">//自定义salt实现  实现序列化接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyByteSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleByteSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(String string)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(string);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在realm中使用自定义salt</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<br><br>    String principal = (String) authenticationToken.getPrincipal();<br>    <span class="hljs-comment">// 从数据库中查询用户名对应的user</span><br>    User user = userService.findByUsername(principal);<br><br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(user)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SimpleAuthenticationInfo(user.getUsername(), user.getPassword(), <span class="hljs-keyword">new</span> MyByteSource(user.getSalt()), <span class="hljs-keyword">this</span>.getName());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="启动项目测试"><a href="#启动项目测试" class="headerlink" title="启动项目测试"></a>启动项目测试</h5><p>登录一下，发现报错了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.6numbml894g0.webp" srcset="/img/loading.gif" alt="image"></p>
<p>debug一下，发现redisTemplate没有自动注入？</p>
<p><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.3uevvonc5f40.webp" srcset="/img/loading.gif" alt="image"></p>
<p>想起之前遇到类似的情况，就把@Autowired换成了@Resource（Autowired是根据类型，Resource是根据名字），结果还是同样报空指针错误</p>
<p>试了试下面的都不好使：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-meta">@Resource(name = &quot;redisTemplate&quot;)</span><br><span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RedisTemplate&lt;xxx, xxx&gt; redisTemplate;<br><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedisTemplate&lt;xxx, xxx&gt; redisTemplate;<br><br><span class="hljs-meta">@Component</span> <span class="hljs-comment">// &lt;-- 把类注册到容器里</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisCache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>&#123; ...<br></code></pre></td></tr></table></figure>

<p>最后终于被我给研究出来了，大概是因为这个Cache跟Filter相关，有时候<strong>⚡Filter太快了⚡，还没注入就开始用了</strong></p>
<p>解决办法就是写个工具类，在类里弄一个<strong>静态</strong>的，用的时候调用静态的template</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.utils;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-meta">@Component</span> <span class="hljs-comment">// 注入Spring容器</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisUtils</span> </span>&#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RedisTemplate redis;<br><br>    <span class="hljs-meta">@PostConstruct</span> <span class="hljs-comment">// 构造时赋值</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">redisTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>        redis = <span class="hljs-keyword">this</span>.redisTemplate;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>修改后的RedisCache</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.aster.springbootshiro.shiro.cache;<br><br><span class="hljs-keyword">import</span> ...<br><br><span class="hljs-comment">// 自定义RedisCache缓存实现</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisCache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Cache</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> String cacheName;<br><br><span class="hljs-comment">//    @Resource</span><br><span class="hljs-comment">//    private RedisTemplate redisTemplate;</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">get</span><span class="hljs-params">(K k)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;获取缓存:&quot;</span> + k);<br>        <span class="hljs-keyword">return</span> (V) getRedisTemplate().opsForHash().get(cacheName, k.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">put</span><span class="hljs-params">(K k, V v)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;设置缓存key: &quot;</span> + k + <span class="hljs-string">&quot; value:&quot;</span> + v);<br>        getRedisTemplate().opsForHash().put(cacheName, k.toString(), v);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> V <span class="hljs-title">remove</span><span class="hljs-params">(K k)</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        <span class="hljs-keyword">return</span> (V) getRedisTemplate().opsForHash().delete(<span class="hljs-keyword">this</span>.cacheName, k.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CacheException </span>&#123;<br>        getRedisTemplate().delete(<span class="hljs-keyword">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().size(<span class="hljs-keyword">this</span>.cacheName).intValue();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;K&gt; <span class="hljs-title">keys</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().keys(<span class="hljs-keyword">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;V&gt; <span class="hljs-title">values</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().values(<span class="hljs-keyword">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-comment">//封装获取redisTemplate</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> RedisTemplate <span class="hljs-title">getRedisTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>        RedisTemplate redisTemplate = RedisUtils.redis; <span class="hljs-comment">// ⭐⭐⭐这里改用工具类啦⭐⭐⭐</span><br>        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> StringRedisSerializer());<br>        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> StringRedisSerializer());<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RedisCache</span><span class="hljs-params">()</span> </span>&#123;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RedisCache</span><span class="hljs-params">(String cacheName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.cacheName = cacheName;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>可以看到，用aster登录一次之后，已经有缓存了：<br><img src="https://cdn.jsdelivr.net/gh/IzayoiAster/-@master/Shiro/image.5fsnru3kwag0.webp" srcset="/img/loading.gif" alt="image"></p>
<blockquote>
<p>p.s. Redis的部分hash操作命令</p>
<ol>
<li><p>redis按照hash进行存值<code>hmset key field1 value1 field2 value2 ...</code></p>
</li>
<li><p>redis得到hash的key中某一个field的值<code>hmget key field</code></p>
<p> 注意：其中field表示你想要查询的field的值，其中field可以有多个值。</p>
</li>
<li><p>redis返回哈希表key的所有field值和所有的value值<code>hgetall key</code></p>
<p>  注意：其中奇数为filed值,偶数为对应的value值。</p>
</li>
<li><p>redis返回哈希表key的所有filed的值<code>hkeys key</code></p>
</li>
</ol>
<ol start="5">
<li><p>redis返回哈希表key的所有的value值<code>hvals key</code></p>
</li>
<li><p>redis删除哈希表key的某一个field值和对应的value值<code>hdel key</code></p>
</li>
<li><p>redis设置key的过期时间<code>expire key time | expireat key time</code></p>
<p> 注意：其中expire key time中的time表示的是秒数，expireat key time中的time表示的是unixtime的标准秒数</p>
</li>
<li><p>redis查看key的到期时间或剩余的剩余的生存时间<code>ttl key</code></p>
</li>
<li><p>redis删除key的过期时间<code>persist key</code></p>
</li>
<li><p>其他的关于redis的一些操作，可以查看<a target="_blank" rel="noopener" href="http://www.runoob.com/redis/redis-tutorial.html">菜鸟教程</a></p>
</li>
</ol>
</blockquote>
<hr>
<h5 id="（附：修改salt不能序列化的问题）"><a href="#（附：修改salt不能序列化的问题）" class="headerlink" title="（附：修改salt不能序列化的问题）"></a>（附：修改salt不能序列化的问题）</h5><p>不一定用得上，总之先放在这儿</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//自定义salt实现  实现序列化接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyByteSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ByteSource</span>,<span class="hljs-title">Serializable</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">byte</span>[] bytes;<br>    <span class="hljs-keyword">private</span> String cachedHex;<br>    <span class="hljs-keyword">private</span> String cachedBase64;<br><br>    <span class="hljs-comment">//加入无参数构造方法实现序列化和反序列化</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">()</span></span>&#123;<br><br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.bytes = bytes;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(<span class="hljs-keyword">char</span>[] chars)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.bytes = CodecSupport.toBytes(chars);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(String string)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.bytes = CodecSupport.toBytes(string);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(ByteSource source)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.bytes = source.getBytes();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(File file)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.bytes = (<span class="hljs-keyword">new</span> MyByteSource.BytesHelper()).getBytes(file);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyByteSource</span><span class="hljs-params">(InputStream stream)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.bytes = (<span class="hljs-keyword">new</span> MyByteSource.BytesHelper()).getBytes(stream);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCompatible</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> o <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">byte</span>[] || o <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">char</span>[] || o <span class="hljs-keyword">instanceof</span> String || o <span class="hljs-keyword">instanceof</span> ByteSource || o <span class="hljs-keyword">instanceof</span> File || o <span class="hljs-keyword">instanceof</span> InputStream;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getBytes() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bytes;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bytes == <span class="hljs-keyword">null</span> || <span class="hljs-keyword">this</span>.bytes.length == <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toHex</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cachedHex == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">this</span>.cachedHex = Hex.encodeToString(<span class="hljs-keyword">this</span>.getBytes());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cachedHex;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toBase64</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cachedBase64 == <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">this</span>.cachedBase64 = Base64.encodeToString(<span class="hljs-keyword">this</span>.getBytes());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.cachedBase64;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toBase64();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.bytes != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-keyword">this</span>.bytes.length != <span class="hljs-number">0</span> ? Arrays.hashCode(<span class="hljs-keyword">this</span>.bytes) : <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object o)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-keyword">this</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">instanceof</span> ByteSource) &#123;<br>            ByteSource bs = (ByteSource)o;<br>            <span class="hljs-keyword">return</span> Arrays.equals(<span class="hljs-keyword">this</span>.getBytes(), bs.getBytes());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BytesHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CodecSupport</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">BytesHelper</span><span class="hljs-params">()</span> </span>&#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getBytes(File file) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toBytes(file);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">byte</span>[] getBytes(InputStream stream) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.toBytes(stream);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Shiro/">Shiro</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/11/24/KMP%E7%AE%97%E6%B3%95/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">KMP算法</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/28/%E8%AE%B0%E4%B8%80%E4%B8%8B%E9%AB%98%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BB%A3%E7%A0%81/">
                        <span class="hidden-mobile">记一下高中的一些代码</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> ×  <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
